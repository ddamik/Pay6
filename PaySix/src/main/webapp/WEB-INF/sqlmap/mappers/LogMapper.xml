<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="LogMapper">



	<!-- 
		1. insert log
		2. order_list ( status: 1 + status: 2 )
		3. update_status
	-->
	
	
	
	<!-- insert log -->
	<insert id="insert_log" parameterType="LogVO">
		insert
			into
		log(
			tno,
			orderno,
			status,
			pid,
			userid,
			paymethod
		)
		values(
			#{tno},
			#{orderno},
			#{status},
			#{pid},
			#{userid},
			#{paymethod}		
		)		
	</insert>
	
	
	<!-- 2. order_list -->
	<select id="onwer_order_list" parameterType="hashmap" resultType="OwnerOrderVO">
		select
			log.seqid as seqid,
			log.orderno as orderno,
			log.tno as tno,        
	        log.status as status,
	        log.ordertime as ordertime,
	        productinfo.pname as pname
		from
			log,
			productinfo
		where
			log.pid = productinfo.pid
		and 
			date(log.ordertime) = date(now())
		and 
			log.status = #{status}
		and
			productinfo.sid = #{sid}
	</select>
	
	<!-- 2. join table -->
	<resultMap type="OwnerOrderVO" id="owner_order_list_status_1">
		<id property="seqid" column="seqid"/>
		<result property="tno" column="tno"/>
		<result property="orderno" column="orderno"/>
		<result property="status" column="status"/>
		<result property="ordertime" column="ordertime"/>
		<result property="pname" column="pname"/>
	</resultMap>
	
	
	
	
	
	<!-- 3. update status -->
	<update id="update_status" parameterType="int">
		update
			log
		set
			status = "2"
		where
			seqid = #{seqid}
	</update>
	
	
	
	
	
	
	
 
	
	<!-- 현재 시간대 판매량 데이터 ( 오늘 / 어제 )-->	
	<select id="currentTime_salesData" parameterType="hashmap" resultType="LogVO">
		select
			log.pid,
			log.ordertime,
			count(log.pid) as etc1,
			productinfo.pprice as etc2
		from
			log,
			productinfo
		where
			concat(year(log.ordertime), '-', month(log.ordertime), '-', day(log.ordertime), ' ', hour(log.ordertime)) = #{current_time}
		and
			log.pid = productinfo.pid
		and
			mid(log.pid, 1, 4) = #{pid}
		group by
			log.pid				
	</select>
	
	
	<!-- 현재 시간까지 판매량 데이터 ( 오늘 / 어제 ) -->
	<select id="yesterday_fromMidNight_salesData" parameterType="hashmap" resultType="LogVO">
		select
			log.pid,
			count(log.pid) as etc1,
			productinfo.pprice as etc2
		from
			log,
			productinfo
		where
			log.ordertime 
		between 
			concat(date_format(DATE_ADD(now(),interval -1 day),'%Y-%m-%d'), ' 00:00:00')
		and
			concat(date_format(DATE_ADD(now(),interval -1 day),'%Y-%m-%d'), ' ', curtime())
		and
			log.pid = productinfo.pid
		and
			mid(log.pid, 1, 4) = #{pid}
		group by
			log.pid;   
	</select>
	
	
		<!-- 현재 시간까지 판매량 데이터 ( 오늘 / 어제 ) -->
	<select id="today_fromMidNight_salesData" parameterType="hashmap" resultType="LogVO">
		select
			log.pid,
			count(log.pid) as etc1,
			productinfo.pprice as etc2
		from
			log,
			productinfo
		where
			log.ordertime 
		between 
			concat(date_format(DATE_ADD(now(),interval 0 day),'%Y-%m-%d'), ' 00:00:00')
		and
			concat(date_format(DATE_ADD(now(),interval 0 day),'%Y-%m-%d'), ' ', curtime())
		and
			log.pid = productinfo.pid
		and
			mid(log.pid, 1, 4) = #{pid}
		group by
			log.pid;   
	</select>
	
	
	
	
	
	
	
	
	
	
	<!-- Random data -->
		<insert id="insert_random_zz" parameterType="LogVO">
		insert
			into
		log(
			tno,
			orderno,
			status,
			pid,
			userid,
			paymethod,
			ordertime
		)
		values(
			#{tno},
			#{orderno},
			#{status},
			#{pid},
			#{userid},
			#{paymethod},
			#{ordertime}		
		)		
	</insert>
	

</mapper>